# Nginx configuration for Valence HTTP MCP Server
# Managed by Ansible - do not edit manually
#
# Proxies all Valence API and MCP endpoints to the local server.

# Valence API and MCP endpoints
location /api/ {
{% if valence_allowed_ips is defined and valence_allowed_ips | length > 0 %}
    # IP allowlist
{% for ip in valence_allowed_ips %}
    allow {{ ip }};
{% endfor %}
    deny all;

{% endif %}
    proxy_pass http://127.0.0.1:8420/api/;
    proxy_http_version 1.1;

    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Pass through Authorization header
    proxy_set_header Authorization $http_authorization;

    # MCP session handling
    proxy_set_header Mcp-Session-Id $http_mcp_session_id;

    # SSE support for streaming MCP
    proxy_set_header Connection '';
    chunked_transfer_encoding off;
    proxy_buffering off;
    proxy_cache off;

    # Timeouts for potentially long tool calls
    proxy_connect_timeout 30s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Max request body size
    client_max_body_size 10M;
}

# Health check (no auth required, short path)
location = /health {
    proxy_pass http://127.0.0.1:8420/api/v1/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Metrics endpoint
location = /metrics {
    proxy_pass http://127.0.0.1:8420/metrics;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# OAuth well-known endpoints
location /.well-known/ {
    proxy_pass http://127.0.0.1:8420/.well-known/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Server info (root)
location = / {
    proxy_pass http://127.0.0.1:8420/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
